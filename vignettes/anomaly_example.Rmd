---
title: "Anomaly Example"
output: html_notebook
---

Load libraries.

```{r}
library(stringr)
library(dplyr)
library(azmpdata)
library(multivaR)
#source('R/anomaly.R')
library(ggplot2)
library(gridExtra, warn.conflicts = FALSE)
```


Get test data files from Benoit. Once azmpdata is finished this section will be replaced by a query to azmpdata.

```{r}

# test files
 fp <- 'C:/Users/chisholme/desktop/April2020- March2021/Data Access/draft_csv/'
 list_fn <- list.files(fp)

 # list_fn <- 'Discrete_Occupations_Sections.csv'


# load in csv

for (i in 1:length(list_fn)){
  # isolate df name

  dfname <- gsub('(\\w+)\\.csv', '\\1', list_fn[i]) # thanks CL for the reg expression!
    #dfname <- 'Derived_Occupations_Sections'
  eval(parse(text = paste(dfname, '<- read.csv(file.path(fp, list_fn[i]))')))

}


```

Calculate monthly and annual anomalies.Modified versions of Chantelle's functions.

```{r}

# test anomaly calcs

dd <- monthlyAnomaly(d = Derived_Occupations_Sections, climatologyYears = c(1999, 2010), var = 'integrated_chlorophyll_0_100')

dd <- monthlyAnomaly(d = dd, climatologyYears = c(1999, 2010), var = 'integrated_nitrate_0_50')

# test annual results

ddann <- annualAnomaly(d = dd, anomaly = 'integrated_chlorophyll_0_100_anomaly')

head(ddann)

```

Improvements to anomaly functions:

* account for possibility of data collection stretching between two months, and wanting one anomaly value (from one cruise)
  * once cruise_id is incorporated into metadata an option will be written into the function to group data by cruise rather than month
  
* Ability to split data by section or station within data frame
  * Benoit's scripts split data by section or station before calculating anomalies
  
* Difference in calculations between Benoit and Chantelle versions
  * Due to difference in calculating monthly vs annual climatology



```{r}

# Benoit's method

derived_annual_section_anomalies <- 
  annualAnomaly_byRegion(data = Derived_Annual_Sections, climatologyYears = c(1999, 2015))

head(derived_annual_section_anomalies)
```


```{r}
# 
# # compare Benoit and Chantelle methods
# 
# anncom <- cbind(df_anomaly_annual_l, ddann)
# par(mar = c(5, 4, 4, 4) + 0.3)  # Leave space for z axis
# plot(anncom$year, anncom$integrated_chlorophyll_0_100_anomaly, type = 'l', col = 'red', ylab = '', xlab = 'Year') # first plot
# par(new = TRUE)
# axis(side = 2, col = 'red')
# par(new = TRUE)
# plot(anncom$year, anncom$annual_anomaly, type = "l", col = 'blue', axes = FALSE, bty = "n", xlab = "", ylab = "")
# axis(side=4, at = pretty(range(anncom$annual_anomaly, na.rm = TRUE)), col = 'blue')
# mtext("annual anomaly - Benoit", side=4, line=3, col = 'blue')
# mtext("annual anomaly - Chantelle", side=2, line=3, col = 'red')
# 

```


